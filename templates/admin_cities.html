{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞–º–∏</h2>
        <div>
            <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</a>
            <a href="{{ url_for('admin_add_city') }}" class="btn btn-success">+ –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥</a>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">–°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤</h5>
        </div>
        <div class="card-body">
            {% if cities %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                            <th>–ú–∞—Å—à—Ç–∞–±</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ò–¥–µ–π</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for city in cities %}
                        <tr>
                            <td>{{ city.id }}</td>
                            <td><strong>{{ city.name }}</strong></td>
                            <td>
                                {% if city.description %}
                                {{ city.description[:50] }}{% if city.description|length > 50 %}...{% endif %}
                                {% else %}
                                <span class="text-muted">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è</span>
                                {% endif %}
                            </td>
                            <td>
                                <small>–®: {{ "%.4f"|format(city.latitude) }}<br>
                                –î: {{ "%.4f"|format(city.longitude) }}</small>
                            </td>
                            <td>{{ city.zoom }}</td>
                            <td>
                                {% if city.is_active %}
                                <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                {% else %}
                                <span class="badge bg-secondary">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                                {% endif %}
                            </td>
                            <td>
                                {% set city_ideas_count = city.city_ideas|length %}
                                {% if city_ideas_count > 0 %}
                                <a href="{{ url_for('ideas_list', city_id=city.id) }}" class="badge bg-info text-decoration-none">
                                    {{ city_ideas_count }}
                                </a>
                                {% else %}
                                <span class="badge bg-secondary">0</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('admin_edit_city', city_id=city.id) }}" 
                                       class="btn btn-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        ‚úèÔ∏è
                                    </a>
                                    <a href="{{ url_for('map_page', city_id=city.id) }}" 
                                       class="btn btn-info" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">
                                        üó∫Ô∏è
                                    </a>
                                    <a href="{{ url_for('admin_delete_city', city_id=city.id) }}" 
                                       class="btn btn-danger" title="–£–¥–∞–ª–∏—Ç—å"
                                       onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥ {{ city.name }}?')">
                                        üóëÔ∏è
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                –ì–æ—Ä–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. <a href="{{ url_for('admin_add_city') }}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥</a>.
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for city in cities %}
                        {% set ideas_count = city.city_ideas|length %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ city.name }}
                            <div>
                                <span class="badge bg-primary rounded-pill">{{ ideas_count }}</span>
                                <small class="text-muted ms-2">
                                    {% if ideas_count > 0 %}
                                    {% set approved_count = city.city_ideas|selectattr('status', 'equalto', 'approved')|list|length %}
                                    <span class="text-success">‚úì{{ approved_count }}</span>
                                    {% endif %}
                                </small>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin_add_city') }}" class="btn btn-success">
                            + –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥
                        </a>
                        <a href="{{ url_for('map_page') }}" class="btn btn-info">
                            üó∫Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≥–æ—Ä–æ–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
                        </a>
                        <button class="btn btn-outline-secondary" onclick="generateTestCities()">
                            üß™ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –≥–æ—Ä–æ–¥–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function generateTestCities() {
    if (confirm('–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –≥–æ—Ä–æ–¥–∞? –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏.')) {
        fetch('/admin/generate_test_cities', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–¢–µ—Å—Ç–æ–≤—ã–µ –≥–æ—Ä–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã!');
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
        });
    }
}
</script>
{% endblock %}