{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h2>
            <div id="mapControls">
                <button class="btn btn-outline-secondary" onclick="zoomIn()" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="zoomOut()" title="–û—Ç–¥–∞–ª–∏—Ç—å">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="locateMe()" title="–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
                    <i class="fas fa-location-arrow"></i>
                </button>
            </div>
        </div>
        
        <!-- –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ -->
        <div class="card mb-4">
            <div class="card-body">
                <h5>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:</h5>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('map_page') }}" 
                       class="btn btn-outline-primary {% if not city %}active{% endif %}">
                        –í—Å–µ –≥–æ—Ä–æ–¥–∞
                    </a>
                    {% for c in cities %}
                    <a href="{{ url_for('map_page', city_id=c.id) }}" 
                       class="btn btn-outline-primary {% if city and city.id == c.id %}active{% endif %}">
                        {{ c.name }}
                    </a>
                    {% endfor %}
                </div>
                {% if city %}
                <div class="mt-2">
                    <small class="text-muted">–¢–µ–∫—É—â–∏–π –≥–æ—Ä–æ–¥: <strong>{{ city.name }}</strong></small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-info-circle fa-2x"></i>
                </div>
                <div>
                    <h5 class="alert-heading mb-1">–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∏–¥–µ—é?</h5>
                    <p class="mb-0">–ü—Ä–æ—Å—Ç–æ –∫–ª–∏–∫–Ω–∏—Ç–µ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ! –í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –∫–∞—Ä—Ç—É, —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∏ —É–º–µ–Ω—å—à–∞—Ç—å –º–∞—Å—à—Ç–∞–± –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞.</p>
                </div>
            </div>
        </div>
        
        <div id="map" style="height: 600px; width: 100%; border-radius: 10px; border: 2px solid #dee2e6;"></div>
        
        <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">–õ–µ–≥–µ–Ω–¥–∞ –∫–∞—Ä—Ç—ã</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–¥–µ–π:</h6>
                        <div class="row">
                            {% for category, color in {
                                '—Å–ø–æ—Ä—Ç': '#4CAF50',
                                '–∫—É–ª—å—Ç—É—Ä–∞': '#2196F3',
                                '–¥–µ—Ç—Å–∫–∏–π –¥–æ—Å—É–≥': '#FF9800',
                                '—ç–∫–æ–ª–æ–≥–∏—è': '#009688',
                                '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç': '#795548',
                                '–±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ': '#9C27B0',
                                '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ': '#F44336',
                                '–∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ': '#607D8B'
                            }.items() %}
                            <div class="col-6 mb-2">
                                <div class="d-flex align-items-center">
                                    <div class="legend-color" style="background-color: {{ color }}; width: 20px; height: 20px; border-radius: 50%; margin-right: 10px;"></div>
                                    <span>{{ category|title }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>–°–∏–º–≤–æ–ª—ã:</h6>
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <div style="width: 24px; height: 24px; background-color: #dc3545; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); margin-right: 10px;"></div>
                                <span>–ù–æ–≤–∞—è –∏–¥–µ—è (–∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ)</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div style="width: 24px; height: 24px; background-color: #28a745; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); margin-right: 10px;"></div>
                                <span>–°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∏–¥–µ—è (–∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–¥–µ–∏ -->
<div class="modal fade" id="addIdeaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∏–¥–µ—é</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if current_user.is_authenticated %}
                <form id="addIdeaForm">
                    <div class="mb-3">
                        <label for="ideaTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–¥–µ–∏ *</label>
                        <input type="text" class="form-control" id="ideaTitle" name="title" required
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–∞–º–µ–π–∫–∞ –≤ –ø–∞—Ä–∫–µ, –î–µ—Ç—Å–∫–∞—è –ø–ª–æ—â–∞–¥–∫–∞ –∏ —Ç.–¥.">
                    </div>
                    
                    <div class="mb-3">
                        <label for="ideaDescription" class="form-label">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ *</label>
                        <textarea class="form-control" id="ideaDescription" name="description" rows="4" required
                                  placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∏–¥–µ—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ. –ß–µ–º –ª—É—á—à–µ –æ–ø–∏—Å–∞–Ω–∞ –∏–¥–µ—è, —Ç–µ–º –±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤ –Ω–∞ –µ—ë —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é."></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="ideaCategory" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                            <select class="form-select" id="ideaCategory" name="category" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="—Å–ø–æ—Ä—Ç">–°–ø–æ—Ä—Ç</option>
                                <option value="–∫—É–ª—å—Ç—É—Ä–∞">–ö—É–ª—å—Ç—É—Ä–∞</option>
                                <option value="–¥–µ—Ç—Å–∫–∏–π –¥–æ—Å—É–≥">–î–µ—Ç—Å–∫–∏–π –¥–æ—Å—É–≥</option>
                                <option value="—ç–∫–æ–ª–æ–≥–∏—è">–≠–∫–æ–ª–æ–≥–∏—è</option>
                                <option value="—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                                <option value="–±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ">–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</option>
                                <option value="–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                                <option value="–∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ">–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="ideaCity" class="form-label">–ì–æ—Ä–æ–¥</label>
                            <select class="form-select" id="ideaCity" name="city_id">
                                <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
                                {% for city in cities %}
                                <option value="{{ city.id }}" {% if city and city.id == city.id %}selected{% endif %}>
                                    {{ city.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</label>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">–®–∏—Ä–æ—Ç–∞</span>
                                    <input type="text" class="form-control" id="ideaLatitude" name="latitude" readonly>
                                </div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">–î–æ–ª–≥–æ—Ç–∞</span>
                                    <input type="text" class="form-control" id="ideaLongitude" name="longitude" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç–µ</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="alert alert-warning">
                            <small>
                                <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–¥–µ—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                                –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
                            </small>
                        </div>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-user-lock fa-4x text-muted"></i>
                    </div>
                    <h4>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h4>
                    <p>–ß—Ç–æ–±—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–¥–µ—é, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-primary" onclick="showLoginModal()">
                            <i class="fas fa-sign-in-alt me-1"></i>–í–æ–π—Ç–∏
                        </button>
                        <button type="button" class="btn btn-success" onclick="showRegisterModal()">
                            <i class="fas fa-user-plus me-1"></i>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                {% if current_user.is_authenticated %}
                <button type="button" class="btn btn-success" onclick="saveIdeaFromMap()">
                    <span id="saveBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–¥–µ—é</span>
                    <span id="saveBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–¥–µ–π -->
<div class="modal fade" id="ideaInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ideaInfoTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ideaInfoBody"></div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary" id="ideaDetailLink">
                    <i class="fas fa-external-link-alt me-1"></i>–ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ª–æ–≥–∏–Ω–∞ -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="modalUsername" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" class="form-control" id="modalUsername" name="username" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalPassword" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="modalPassword" name="password" required>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" onclick="submitLogin()">–í–æ–π—Ç–∏</button>
                    </div>
                </form>
                
                <div class="mt-3 text-center">
                    <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showRegisterModal()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="regUsername" class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
                        <input type="text" class="form-control" id="regUsername" name="username" required>
                        <div class="form-text">–û—Ç 3 –¥–æ 80 —Å–∏–º–≤–æ–ª–æ–≤</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="regEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="regEmail" name="email" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="regPassword" class="form-label">–ü–∞—Ä–æ–ª—å *</label>
                        <input type="password" class="form-control" id="regPassword" name="password" required>
                        <div class="form-text">–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="regConfirmPassword" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è *</label>
                        <input type="password" class="form-control" id="regConfirmPassword" name="confirm_password" required>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="submitRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </div>
                </form>
                
                <div class="mt-3 text-center">
                    <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="showLoginModal()">–í–æ–π–¥–∏—Ç–µ</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.css" />

<script>
    let map;
    let markers = [];
    let temporaryMarker = null;
    let selectedCoords = null;
    let currentCityId = {{ city.id if city else 'null' }};
    
    const categoryColors = {
        '—Å–ø–æ—Ä—Ç': '#4CAF50',
        '–∫—É–ª—å—Ç—É—Ä–∞': '#2196F3',
        '–¥–µ—Ç—Å–∫–∏–π –¥–æ—Å—É–≥': '#FF9800',
        '—ç–∫–æ–ª–æ–≥–∏—è': '#009688',
        '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç': '#795548',
        '–±–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ': '#9C27B0',
        '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ': '#F44336',
        '–∑–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ': '#607D8B'
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        let centerLat = 55.7558;
        let centerLng = 37.6173;
        let zoomLevel = 5;
        
        {% if city %}
            centerLat = {{ city.latitude }};
            centerLng = {{ city.longitude }};
            zoomLevel = {{ city.zoom }};
        {% endif %}
        
        map = L.map('map').setView([centerLat, centerLng], zoomLevel);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: '–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞...',
            errorMessage: '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω',
            showResultIcons: true,
            collapsed: false
        }).on('markgeocode', function(e) {
            const center = e.geocode.center;
            map.setView(center, 16);
            
            L.popup()
                .setLatLng(center)
                .setContent('<div class="text-center"><p><strong>–ù–∞–π–¥–µ–Ω–æ:</strong> ' + e.geocode.name + '</p><p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–¥–µ—é –∑–¥–µ—Å—å</p></div>')
                .openOn(map);
        }).addTo(map);
        
        loadIdeas();
        
        map.on('click', function(e) {
            handleMapClick(e.latlng);
        });
        
        map.on('dblclick', function(e) {
            map.setView(e.latlng, map.getZoom() + 1);
        });
        
        if (!localStorage.getItem('mapInstructionShown')) {
            setTimeout(() => {
                L.popup()
                    .setLatLng(map.getCenter())
                    .setContent('<div class="text-center"><h6>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h6><p>–ö–ª–∏–∫–Ω–∏—Ç–µ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∏–¥–µ—é</p></div>')
                    .openOn(map);
                localStorage.setItem('mapInstructionShown', 'true');
            }, 1000);
        }
    });
    
    function handleMapClick(latlng) {
        if (!current_user_authenticated) {
            showLoginModal();
            return;
        }
        
        if (temporaryMarker) {
            map.removeLayer(temporaryMarker);
        }
        
        temporaryMarker = L.marker(latlng, {
            icon: L.divIcon({
                className: 'temporary-marker',
                html: `
                    <div style="
                        background-color: #dc3545;
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        animation: pulse 1.5s infinite;
                        cursor: pointer;
                    ">
                        <i class="fas fa-plus" style="color: white; font-size: 12px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></i>
                    </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map);
        
        L.popup()
            .setLatLng(latlng)
            .setContent('<div class="text-center"><p><strong>–í—ã –≤—ã–±—Ä–∞–ª–∏ –º–µ—Å—Ç–æ!</strong></p><p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–¥–µ–∏</p></div>')
            .openOn(map);
        
        showAddIdeaModal(latlng.lat, latlng.lng);
    }
    
    function loadIdeas() {
        let url = '/api/ideas';
        if (currentCityId) {
            url += '?city_id=' + currentCityId;
        }
        
        fetch(url)
            .then(response => {
                if (response.status === 401) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                    showLoginInfoOnMap();
                    return [];
                }
                return response.json();
            })
            .then(ideas => {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                
                ideas.forEach(idea => {
                    let iconColor = categoryColors[idea.category] || '#666666';
                    
                    let normalIcon = L.divIcon({
                        className: 'idea-marker',
                        html: `
                            <div style="
                                background-color: ${iconColor};
                                width: 28px;
                                height: 28px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                            ">
                                <i class="fas fa-lightbulb" style="color: white; font-size: 14px;"></i>
                            </div>
                        `,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    
                    let hoverIcon = L.divIcon({
                        className: 'idea-marker-hover',
                        html: `
                            <div style="
                                background-color: ${iconColor};
                                width: 32px;
                                height: 32px;
                                border-radius: 50%;
                                border: 3px solid yellow;
                                box-shadow: 0 4px 10px rgba(0,0,0,0.4);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                            ">
                                <i class="fas fa-lightbulb" style="color: white; font-size: 16px;"></i>
                            </div>
                        `,
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    });
                    
                    let marker = L.marker([idea.lat, idea.lng], {icon: normalIcon})
                        .addTo(map)
                        .on('click', function() {
                            if (!current_user_authenticated) {
                                showLoginModal();
                            } else {
                                showIdeaInfo(idea);
                            }
                        })
                        .on('mouseover', function() {
                            this.setIcon(hoverIcon);
                        })
                        .on('mouseout', function() {
                            this.setIcon(normalIcon);
                        });
                    
                    markers.push(marker);
                });
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–¥–µ–π:', error);
                showLoginInfoOnMap();
            });
    }
    
    function showLoginInfoOnMap() {
        L.popup()
            .setLatLng(map.getCenter())
            .setContent(`
                <div class="text-center">
                    <h6>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h6>
                    <p>–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–¥–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-sm btn-primary" onclick="showLoginModal()">–í–æ–π—Ç–∏</button>
                        <button class="btn btn-sm btn-success" onclick="showRegisterModal()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    </div>
                </div>
            `)
            .openOn(map);
    }
    
    function showAddIdeaModal(lat, lng) {
        selectedCoords = { lat: lat, lng: lng };
        
        document.getElementById('ideaLatitude').value = lat.toFixed(6);
        document.getElementById('ideaLongitude').value = lng.toFixed(6);
        
        if (currentCityId) {
            document.getElementById('ideaCity').value = currentCityId;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('addIdeaModal'));
        modal.show();
        
        setTimeout(() => {
            document.getElementById('ideaTitle').focus();
        }, 500);
    }
    
    function showIdeaInfo(idea) {
        document.getElementById('ideaInfoTitle').textContent = idea.title;
        
        let infoHTML = `
            <div class="mb-3">
                <span class="badge" style="background-color: ${categoryColors[idea.category] || '#666'}">${idea.category}</span>
            </div>
            <p class="mb-3">${idea.description.substring(0, 200)}${idea.description.length > 200 ? '...' : ''}</p>
            <div class="row mb-3">
                <div class="col-6">
                    <small><strong>–ê–≤—Ç–æ—Ä:</strong><br>${idea.user}</small>
                </div>
                <div class="col-6">
                    <small><strong>–î–∞—Ç–∞:</strong><br>${idea.created_at}</small>
                </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-success">${idea.votes} üëç</span>
                <small class="text-muted">–ö–ª–∏–∫–Ω–∏—Ç–µ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</small>
            </div>
        `;
        
        document.getElementById('ideaInfoBody').innerHTML = infoHTML;
        document.getElementById('ideaDetailLink').href = '/idea/' + idea.id;
        
        const modal = new bootstrap.Modal(document.getElementById('ideaInfoModal'));
        modal.show();
    }
    
    function saveIdeaFromMap() {
        const title = document.getElementById('ideaTitle').value.trim();
        const description = document.getElementById('ideaDescription').value.trim();
        const category = document.getElementById('ideaCategory').value;
        const cityId = document.getElementById('ideaCity').value;
        
        if (!title) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–¥–µ–∏');
            document.getElementById('ideaTitle').focus();
            return;
        }
        
        if (!description) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏');
            document.getElementById('ideaDescription').focus();
            return;
        }
        
        if (!category) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            document.getElementById('ideaCategory').focus();
            return;
        }
        
        const saveBtn = document.querySelector('#addIdeaModal .btn-success');
        const saveBtnText = document.getElementById('saveBtnText');
        const saveBtnSpinner = document.getElementById('saveBtnSpinner');
        
        saveBtn.disabled = true;
        saveBtnText.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveBtnSpinner.classList.remove('d-none');
        
        fetch('/add_idea_ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                description: description,
                category: category,
                latitude: selectedCoords.lat,
                longitude: selectedCoords.lng,
                city_id: cityId || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('addIdeaModal')).hide();
                
                if (temporaryMarker) {
                    map.removeLayer(temporaryMarker);
                    temporaryMarker = null;
                }
                
                showNotification('–ò–¥–µ—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞! –û–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞—Å—å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.', 'success');
                
                setTimeout(() => {
                    loadIdeas();
                }, 1000);
                
                setTimeout(() => {
                    if (data.idea_id) {
                        window.location.href = '/idea/' + data.idea_id;
                    }
                }, 3000);
                
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
                resetSaveButton();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–¥–µ–∏');
            resetSaveButton();
        });
    }
    
    function resetSaveButton() {
        const saveBtn = document.querySelector('#addIdeaModal .btn-success');
        const saveBtnText = document.getElementById('saveBtnText');
        const saveBtnSpinner = document.getElementById('saveBtnSpinner');
        
        saveBtn.disabled = false;
        saveBtnText.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–¥–µ—é';
        saveBtnSpinner.classList.add('d-none');
    }
    
    function showNotification(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        alertDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2 fa-lg"></i>
                <div>
                    <strong>${type === 'success' ? '–£—Å–ø–µ—à–Ω–æ!' : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}</strong><br>
                    ${message}
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    function zoomIn() {
        map.zoomIn();
    }
    
    function zoomOut() {
        map.zoomOut();
    }
    
    function locateMe() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 16);
                    
                    L.popup()
                        .setLatLng([lat, lng])
                        .setContent('<div class="text-center"><p><strong>–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</strong></p><p>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–¥–µ—é</p></div>')
                        .openOn(map);
                },
                function(error) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ' + error.message);
                }
            );
        } else {
            alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
        }
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ª–æ–≥–∏–Ω–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function showLoginModal() {
        const addIdeaModal = bootstrap.Modal.getInstance(document.getElementById('addIdeaModal'));
        if (addIdeaModal) addIdeaModal.hide();
        
        const modal = new bootstrap.Modal(document.getElementById('loginModal'));
        modal.show();
        
        setTimeout(() => {
            document.getElementById('modalUsername').focus();
        }, 500);
    }
    
    function showRegisterModal() {
        const addIdeaModal = bootstrap.Modal.getInstance(document.getElementById('addIdeaModal'));
        if (addIdeaModal) addIdeaModal.hide();
        
        const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
        if (loginModal) loginModal.hide();
        
        const modal = new bootstrap.Modal(document.getElementById('registerModal'));
        modal.show();
        
        setTimeout(() => {
            document.getElementById('regUsername').focus();
        }, 500);
    }
    
    function submitLogin() {
        const username = document.getElementById('modalUsername').value.trim();
        const password = document.getElementById('modalPassword').value;
        
        if (!username || !password) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }
        
        fetch('/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text();
            }
        })
        .then(data => {
            if (data) {
                alert('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ');
        });
    }
    
    function submitRegister() {
        const username = document.getElementById('regUsername').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regConfirmPassword').value;
        
        if (!username || !email || !password || !confirmPassword) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }
        
        if (password !== confirmPassword) {
            alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
            return;
        }
        
        if (password.length < 6) {
            alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
            return;
        }
        
        fetch('/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `username=${encodeURIComponent(username)}&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&confirm_password=${encodeURIComponent(confirmPassword)}`
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text();
            }
        })
        .then(data => {
            if (data && data.includes('–û—à–∏–±–∫–∞')) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –í–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
        });
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const current_user_authenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
    
    document.getElementById('addIdeaModal').addEventListener('hidden.bs.modal', function () {
        if (document.getElementById('addIdeaForm')) {
            document.getElementById('addIdeaForm').reset();
        }
        resetSaveButton();
        
        if (temporaryMarker) {
            map.removeLayer(temporaryMarker);
            temporaryMarker = null;
        }
    });
</script>

<style>
    #map {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .temporary-marker {
        background: none !important;
        border: none !important;
    }
    
    .idea-marker, .idea-marker-hover {
        background: none !important;
        border: none !important;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .leaflet-popup-content {
        max-height: 300px;
        overflow-y: auto;
        min-width: 250px;
    }
    
    .leaflet-control-geocoder {
        width: 300px;
        max-width: 90%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .legend-color {
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .modal-backdrop {
        z-index: 1040;
    }
    
    .modal {
        z-index: 1050;
    }
    
    #mapControls {
        display: flex;
        gap: 8px;
    }
    
    #mapControls button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}